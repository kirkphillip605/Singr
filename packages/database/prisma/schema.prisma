// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, pgcrypto]
}

// ============================================================================
// ENUM TYPES
// ============================================================================

enum BrandingOwnerType {
  platform
  customer

  @@map("branding_owner_type")
}

enum BrandingStatus {
  active
  suspended
  revoked

  @@map("branding_status")
}

enum OrganizationUserStatus {
  invited
  active
  suspended
  revoked

  @@map("organization_user_status")
}

enum ApiKeyStatus {
  active
  revoked
  expired
  suspended

  @@map("api_key_status")
}

enum SubscriptionStatus {
  incomplete
  incomplete_expired
  trialing
  active
  past_due
  canceled
  unpaid
  paused

  @@map("subscription_status")
}

// ============================================================================
// CORE IDENTITY MODELS
// ============================================================================

model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @map("users_id") @db.Uuid
  email           String    @unique
  passwordHash    String?   @map("password_hash")
  passwordAlgo    String?   @default("argon2id") @map("password_algo")
  name            String?
  displayName     String?   @map("display_name")
  phoneNumber     String?   @map("phone_number")
  imageUrl        String?   @map("image_url")
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  lastLoginAt     DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile     CustomerProfile?
  singerProfile       SingerProfile?
  accounts            Account[]
  sessions            Session[]
  userRoles           UserRole[]
  organizationUsers   OrganizationUser[]  @relation("OrganizationUserUser")
  organizationInvites OrganizationUser[]  @relation("OrganizationUserInvitedBy")
  apiKeysCreated      ApiKey[]            @relation("ApiKeyCreatedBy")
  requestsSubmitted   Request[]           @relation("RequestSubmittedBy")
  savedReports        SavedReport[]
  reportExecutions    ReportExecution[]

  @@index([email])
  @@index([phoneNumber])
  @@map("users")
}

model Role {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @map("roles_id") @db.Uuid
  slug        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  rolePermissions   RolePermission[]
  userRoles         UserRole[]
  organizationUsers OrganizationUser[]

  @@index([slug])
  @@map("roles")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @map("permissions_id") @db.Uuid
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  rolePermissions             RolePermission[]
  organizationUserPermissions OrganizationUserPermission[]

  @@index([slug])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @map("role_permissions_id") @db.Uuid
  roleId       String   @map("roles_id") @db.Uuid
  permissionId String   @map("permissions_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([roleId, permissionId], map: "ux_role_permissions_role_permission")
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRole {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @map("user_roles_id") @db.Uuid
  userId    String   @map("users_id") @db.Uuid
  roleId    String   @map("roles_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, roleId], map: "ux_user_roles_user_role")
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Account {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("accounts_id") @db.Uuid
  userId            String   @map("users_id") @db.Uuid
  provider          String
  providerAccountId String   @map("provider_account_id")
  type              String
  refreshToken      String?  @map("refresh_token")
  accessToken       String?  @map("access_token")
  expiresAt         BigInt?  @map("expires_at")
  tokenType         String?  @map("token_type")
  scope             String?
  idToken           String?  @map("id_token")
  sessionState      String?  @map("session_state")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @map("sessions_id") @db.Uuid
  userId       String   @map("users_id") @db.Uuid
  sessionToken String   @unique @map("session_token")
  expiresAt    DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expiresAt  DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@id([identifier, token])
  @@index([expiresAt], map: "idx_verification_tokens_expires")
  @@map("verification_tokens")
}

// ============================================================================
// PROFILE MODELS
// ============================================================================

model CustomerProfile {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("customer_profiles_id") @db.Uuid
  userId            String   @unique @map("users_id") @db.Uuid
  legalBusinessName String?  @map("legal_business_name")
  dbaName           String?  @map("dba_name")
  stripeCustomerId  String?  @map("stripe_customer_id")
  contactEmail      String?  @map("contact_email")
  contactPhone      String?  @map("contact_phone")
  timezone          String?  @default("UTC")
  billingAddress    Json?    @map("billing_address")
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  customers         Customer[]
  apiKeys           ApiKey[]
  state             State?
  venues            Venue[]
  systems           System[]
  songdb            SongDb[]
  subscriptions     Subscription[]
  organizationUsers OrganizationUser[]
  brandedApps       BrandedApp[]
  savedReports      SavedReport[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@map("customer_profiles")
}

model SingerProfile {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @map("singer_profiles_id") @db.Uuid
  userId      String   @unique @map("users_id") @db.Uuid
  nickname    String?
  avatarUrl   String?  @map("avatar_url")
  preferences Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  favoriteSongs   SingerFavoriteSong[]
  favoriteVenues  SingerFavoriteVenue[]
  requestHistory  SingerRequestHistory[]
  requests        Request[]

  @@index([userId])
  @@map("singer_profiles")
}

// ============================================================================
// ORGANIZATION MODELS
// ============================================================================

model OrganizationUser {
  id                  String                   @id @default(dbgenerated("gen_random_uuid()")) @map("organization_users_id") @db.Uuid
  customerProfileId   String                   @map("customer_profiles_id") @db.Uuid
  userId              String                   @map("users_id") @db.Uuid
  invitedByUserId     String?                  @map("invited_by_user_id") @db.Uuid
  roleId              String?                  @map("role_id") @db.Uuid
  status              OrganizationUserStatus   @default(invited)
  invitationToken     String?                  @map("invitation_token")
  invitationExpiresAt DateTime?                @map("invitation_expires_at") @db.Timestamptz(6)
  lastAccessedAt      DateTime?                @map("last_accessed_at") @db.Timestamptz(6)
  createdAt           DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile              @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user            User                         @relation("OrganizationUserUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  invitedBy       User?                        @relation("OrganizationUserInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  role            Role?                        @relation(fields: [roleId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  permissions     OrganizationUserPermission[]

  @@unique([customerProfileId, userId], map: "ux_organization_users_customer_user")
  @@index([customerProfileId])
  @@index([userId])
  @@index([status])
  @@map("organization_users")
}

model OrganizationUserPermission {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @map("organization_user_permissions_id") @db.Uuid
  organizationUserId String   @map("organization_users_id") @db.Uuid
  permissionId       String   @map("permissions_id") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organizationUser OrganizationUser @relation(fields: [organizationUserId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission       Permission       @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([organizationUserId, permissionId], map: "ux_org_user_permissions")
  @@index([organizationUserId])
  @@index([permissionId])
  @@map("organization_user_permissions")
}

// ============================================================================
// STRIPE AND BILLING MODELS
// ============================================================================

model Customer {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("customers_id")
  stripeCustomerId  String   @map("stripe_customer_id")
  customerProfileId String   @map("customer_profiles_id") @db.Uuid
  email             String?
  name              String?
  phone             String?
  description       String?
  metadata          Json     @default("{}")
  invoiceSettings   Json     @map("invoice_settings") @default("{}")
  shipping          Json     @default("{}")
  taxExempt         String?  @map("tax_exempt")
  taxIds            Json     @map("tax_ids") @default("[]")
  livemode          Boolean  @default(false)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile  CustomerProfile           @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  apiKeys          ApiKey[]
  checkoutSessions StripeCheckoutSession[]

  @@unique([stripeCustomerId])
  @@index([customerProfileId])
  @@map("customers")
}

model Subscription {
  id                 String             @id @db.Uuid @map("subscriptions_id")
  stripeSubId        String             @map("stripe_sub_id")
  customerProfileId  String             @map("customer_profiles_id") @db.Uuid
  priceId            String             @map("prices_id") @db.Uuid
  status             SubscriptionStatus
  currentPeriodStart DateTime           @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd   DateTime           @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd  Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt         DateTime?          @map("canceled_at") @db.Timestamptz(6)
  trialStart         DateTime?          @map("trial_start") @db.Timestamptz(6)
  trialEnd           DateTime?          @map("trial_end") @db.Timestamptz(6)
  metadata           Json               @default("{}")
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  price           Price           @relation(fields: [priceId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@unique([stripeSubId])
  @@index([customerProfileId])
  @@index([status])
  @@map("subscriptions")
}

model Product {
  id          String   @id @db.Uuid @map("products_id")
  stripeId    String   @map("stripe_id")
  name        String
  description String?
  active      Boolean  @default(true)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  prices Price[]

  @@unique([stripeId])
  @@map("products")
}

model Price {
  id            String   @id @db.Uuid @map("prices_id")
  stripeId      String   @map("stripe_id")
  productId     String   @map("products_id") @db.Uuid
  active        Boolean  @default(true)
  currency      String
  type          String
  unitAmount    BigInt?  @map("unit_amount")
  interval      String?
  intervalCount Int?     @map("interval_count")
  trialDays     Int?     @map("trial_days")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  subscriptions Subscription[]

  @@unique([stripeId])
  @@index([productId])
  @@map("prices")
}

model StripeWebhookEvent {
  id          String   @id @db.Uuid @map("stripe_webhook_events_id")
  stripeId    String   @map("stripe_id")
  type        String
  livemode    Boolean
  apiVersion  String?  @map("api_version")
  data        Json
  processed   Boolean  @default(false)
  processedAt DateTime? @map("processed_at") @db.Timestamptz(6)
  error       String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([stripeId])
  @@index([type])
  @@index([processed])
  @@index([createdAt])
  @@map("stripe_webhook_events")
}

model StripeCheckoutSession {
  id                String   @id @db.Uuid @map("stripe_checkout_sessions_id")
  stripeSessionId   String   @map("stripe_session_id")
  customerId        String   @map("customers_id") @db.Uuid
  mode              String
  status            String
  successUrl        String?  @map("success_url")
  cancelUrl         String?  @map("cancel_url")
  paymentStatus     String?  @map("payment_status")
  subscriptionId    String?  @map("subscription_id")
  amountTotal       BigInt?  @map("amount_total")
  currency          String?
  metadata          Json     @default("{}")
  expiresAt         DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([stripeSessionId])
  @@index([customerId])
  @@index([status])
  @@map("stripe_checkout_sessions")
}

// ============================================================================
// VENUE AND SYSTEM MODELS
// ============================================================================

model State {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("state_id") @db.Uuid
  customerProfileId String   @unique @map("customer_profiles_id") @db.Uuid
  state             Json     @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([customerProfileId])
  @@map("state")
}

model Venue {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("venues_id") @db.Uuid
  customerProfileId String   @map("customer_profiles_id") @db.Uuid
  name              String
  urlName           String   @unique @map("url_name")
  description       String?
  address           String?
  city              String?
  state             String?
  postalCode        String?  @map("postal_code")
  country           String?  @default("US")
  phone             String?
  website           String?
  timezone          String?  @default("UTC")
  latitude          Float?
  longitude         Float?
  isActive          Boolean  @default(true) @map("is_active")
  settings          Json?    @default("{}")
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile       CustomerProfile        @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  systems               System[]
  requests              Request[]
  singerFavoriteVenues  SingerFavoriteVenue[]
  singerRequestHistory  SingerRequestHistory[]

  @@index([customerProfileId])
  @@index([urlName])
  @@index([isActive])
  @@map("venues")
}

model System {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("systems_id") @db.Uuid
  customerProfileId String   @map("customer_profiles_id") @db.Uuid
  venueId           String   @map("venues_id") @db.Uuid
  name              String
  description       String?
  isActive          Boolean  @default(true) @map("is_active")
  settings          Json?    @default("{}")
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  venue           Venue           @relation(fields: [venueId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  songdb          SongDb[]
  requests        Request[]

  @@index([customerProfileId])
  @@index([venueId])
  @@index([isActive])
  @@map("systems")
}

model SongDb {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("songdb_id") @db.Uuid
  customerProfileId String   @map("customer_profiles_id") @db.Uuid
  systemId          String   @map("systems_id") @db.Uuid
  artist            String
  title             String
  discId            String?  @map("disc_id")
  duration          Int?
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  system          System          @relation(fields: [systemId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([customerProfileId])
  @@index([systemId])
  @@index([artist, title])
  @@map("songdb")
}

model Request {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @map("requests_id") @db.Uuid
  venueId           String    @map("venues_id") @db.Uuid
  systemId          String    @map("systems_id") @db.Uuid
  singerProfileId   String?   @map("singer_profiles_id") @db.Uuid
  submittedByUserId String?   @map("submitted_by_user_id") @db.Uuid
  singerName        String    @map("singer_name")
  artist            String
  title             String
  keyChange         Int       @default(0) @map("key_change")
  notes             String?
  status            String    @default("pending")
  priority          Int       @default(0)
  position          Int       @default(0)
  requestedAt       DateTime  @default(now()) @map("requested_at") @db.Timestamptz(6)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  venue           Venue          @relation(fields: [venueId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  system          System         @relation(fields: [systemId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  singerProfile   SingerProfile? @relation(fields: [singerProfileId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  submittedByUser User?          @relation("RequestSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([venueId])
  @@index([systemId])
  @@index([singerProfileId])
  @@index([status])
  @@index([requestedAt])
  @@map("requests")
}

// ============================================================================
// API KEY MODELS
// ============================================================================

model ApiKey {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @map("api_keys_id") @db.Uuid
  customerProfileId String       @map("customer_profiles_id") @db.Uuid
  customerId        String       @map("customers_id") @db.Uuid
  name              String
  keyHash           String       @map("key_hash")
  keyPrefix         String       @map("key_prefix")
  status            ApiKeyStatus @default(active)
  expiresAt         DateTime?    @map("expires_at") @db.Timestamptz(6)
  lastUsedAt        DateTime?    @map("last_used_at") @db.Timestamptz(6)
  rateLimit         Int?         @map("rate_limit")
  permissions       Json?        @default("[]")
  createdByUserId   String?      @map("created_by_user_id") @db.Uuid
  metadata          Json?        @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  createdBy       User?           @relation("ApiKeyCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@unique([keyHash])
  @@index([customerProfileId])
  @@index([customerId])
  @@index([keyPrefix])
  @@index([status])
  @@map("api_keys")
}

// ============================================================================
// SINGER FEATURE MODELS
// ============================================================================

model SingerFavoriteSong {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @map("singer_favorite_songs_id") @db.Uuid
  singerProfileId String   @map("singer_profiles_id") @db.Uuid
  artist          String?
  title           String?
  keyChange       Int      @default(0) @map("key_change")
  metadata        Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  singerProfile SingerProfile @relation(fields: [singerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([singerProfileId, artist, title, keyChange])
  @@index([singerProfileId])
  @@map("singer_favorite_songs")
}

model SingerRequestHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @map("singer_request_history_id") @db.Uuid
  singerProfileId String   @map("singer_profiles_id") @db.Uuid
  venueId         String   @map("venues_id") @db.Uuid
  artist          String
  title           String
  keyChange       Int      @default(0) @map("key_change")
  requestedAt     DateTime @default(now()) @map("requested_at") @db.Timestamptz(6)
  songFingerprint String   @map("song_fingerprint")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  singerProfile SingerProfile @relation(fields: [singerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  venue         Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([singerProfileId])
  @@index([singerProfileId, requestedAt])
  @@index([venueId])
  @@map("singer_request_history")
}

model SingerFavoriteVenue {
  singerProfileId String   @map("singer_profiles_id") @db.Uuid
  venueId         String   @map("venues_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  singerProfile SingerProfile @relation(fields: [singerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  venue         Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([singerProfileId, venueId])
  @@index([singerProfileId])
  @@index([venueId])
  @@map("singer_favorite_venues")
}

// ============================================================================
// BRANDING MODELS
// ============================================================================

model BrandingProfile {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @map("branding_profiles_id") @db.Uuid
  ownerType      BrandingOwnerType @map("owner_type")
  ownerId        String?           @map("owner_id") @db.Uuid
  name           String
  logoUrl        String?           @map("logo_url")
  colorPalette   Json              @map("color_palette") @default("{}")
  poweredBySingr Boolean           @default(true) @map("powered_by_singr")
  domain         String?
  appBundleId    String?           @map("app_bundle_id")
  appPackageName String?           @map("app_package_name")
  status         BrandingStatus    @default(active)
  metadata       Json?             @default("{}")
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  brandedApps BrandedApp[]

  @@unique([ownerType, ownerId, name], map: "ux_branding_profiles_owner")
  @@index([ownerType, ownerId])
  @@index([status])
  @@map("branding_profiles")
}

model BrandedApp {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @map("branded_apps_id") @db.Uuid
  customerProfileId String         @map("customer_profiles_id") @db.Uuid
  brandingProfileId String         @map("branding_profiles_id") @db.Uuid
  name              String
  platform          String
  bundleIdentifier  String?        @map("bundle_identifier")
  status            BrandingStatus @default(active)
  config            Json           @default("{}")
  rateLimitOverride Json?          @map("rate_limit_override")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile    @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  brandingProfile BrandingProfile    @relation(fields: [brandingProfileId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  apiKeys         BrandedAppApiKey[]

  @@index([customerProfileId])
  @@index([brandingProfileId])
  @@map("branded_apps")
}

model BrandedAppApiKey {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @map("branded_app_api_keys_id") @db.Uuid
  brandedAppId String         @map("branded_apps_id") @db.Uuid
  apiKeyHash   String         @map("api_key_hash")
  description  String?
  lastUsedAt   DateTime?      @map("last_used_at") @db.Timestamptz(6)
  status       BrandingStatus @default(active)
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  brandedApp BrandedApp @relation(fields: [brandedAppId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([brandedAppId, apiKeyHash])
  @@index([brandedAppId])
  @@index([apiKeyHash])
  @@map("branded_app_api_keys")
}

// ============================================================================
// AUDIT AND ANALYTICS MODELS
// ============================================================================

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @map("audit_logs_id") @db.Uuid
  tableName String   @map("table_name")
  recordId  String?  @map("record_id")
  userId    String?  @map("user_id") @db.Uuid
  operation String
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tableName, recordId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

model SavedReport {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @map("saved_reports_id") @db.Uuid
  customerProfileId String   @map("customer_profiles_id") @db.Uuid
  createdByUserId   String   @map("created_by_users_id") @db.Uuid
  name              String
  description       String?
  reportType        String   @map("report_type")
  filters           Json     @default("{}")
  columns           String[] @default([])
  sortBy            Json     @map("sort_by") @default("[]")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  customerProfile CustomerProfile   @relation(fields: [customerProfileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  createdByUser   User              @relation(fields: [createdByUserId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  executions      ReportExecution[]

  @@index([customerProfileId])
  @@index([createdByUserId])
  @@map("saved_reports")
}

model ReportExecution {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @map("report_executions_id") @db.Uuid
  savedReportId    String    @map("saved_reports_id") @db.Uuid
  executedByUserId String    @map("executed_by_users_id") @db.Uuid
  reportType       String    @map("report_type")
  filters          Json      @default("{}")
  format           String
  rowCount         Int?      @map("row_count")
  executionTimeMs  Int?      @map("execution_time_ms")
  fileUrl          String?   @map("file_url")
  fileSizeBytes    BigInt?   @map("file_size_bytes")
  expiresAt        DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  savedReport    SavedReport @relation(fields: [savedReportId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  executedByUser User        @relation(fields: [executedByUserId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([savedReportId])
  @@index([executedByUserId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("report_executions")
}
